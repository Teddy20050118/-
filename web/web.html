<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é»é¤åŠ©ç†</title>
  <link rel="stylesheet" href="/web/web.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

  <div class="app-container">
    <header>
      <h1> é»é¤åŠ©ç†</h1>
    </header>

    <div id="chat-box">
      <div class="message bot">
        <div class="avatar">ğŸ¤–</div>
        <div class="bubble">
          ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„é»é¤åŠ©ç†ã€‚<br>
          è«‹å‘Šè¨´æˆ‘ä½ çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šã€Œ<b>é ç®— 300 å…ƒï¼Œæƒ³åƒä¸è¾£çš„</b>ã€æˆ–ã€Œ<b>5å€‹äººèšé¤ï¼Œè¦æœ‰é£²æ–™</b>ã€ã€‚
        </div>
      </div>
    </div>

    <div id="loading-indicator" class="message bot hidden">
      <div class="avatar">ğŸ¤–</div>
      <div class="bubble loading">
        <span></span><span></span><span></span>
      </div>
    </div>

    <div id="input-area">
      <div class="input-wrapper">
        <input id="input" type="text" placeholder="è¼¸å…¥ä½ çš„éœ€æ±‚..." autocomplete="off" />
        <button id="send-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
      </div>
    </div>
  </div>

<script>
  const sid = (crypto.randomUUID && crypto.randomUUID()) || String(Date.now());
  const chatBox = document.getElementById('chat-box');
  const input = document.getElementById('input');
  const sendBtn = document.getElementById('send-btn');
  const loading = document.getElementById('loading-indicator');

  // ç°¡å–®çš„æ–‡å­—è½‰ HTML è™•ç† (è™•ç†æ›è¡Œèˆ‡ç²—é«”)
  function formatText(text) {
    if (!text) return "";
    // å°‡æ›è¡Œç¬¦è™Ÿè½‰ç‚º <br>
    let html = text.replace(/\n/g, '<br>');
    // å°‡ **æ–‡å­—** è½‰ç‚º <strong>æ–‡å­—</strong> (ç°¡å–® Markdown)
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    return html;
  }

  function appendMessage(role, text) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${role}`;
    
    let contentHtml = '';
    if (role === 'bot') {
        contentHtml = `
            <div class="avatar">ğŸ¤–</div>
            <div class="bubble">${formatText(text)}</div>
        `;
    } else {
        contentHtml = `
            <div class="bubble">${formatText(text)}</div>
        `;
    }
    
    msgDiv.innerHTML = contentHtml;
    chatBox.appendChild(msgDiv);
    scrollToBottom();
  }

  function scrollToBottom() {
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function showLoading(show) {
    if (show) {
      loading.classList.remove('hidden');
      chatBox.appendChild(loading); // ç§»å‹•åˆ°æœ€ä¸‹æ–¹
      scrollToBottom();
    } else {
      loading.classList.add('hidden');
    }
  }

  async function send() {
    const text = input.value.trim();
    if (!text) return;

    // 1. é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
    input.value = '';
    appendMessage('user', text);

    // 2. é¡¯ç¤ºè¼‰å…¥ä¸­
    showLoading(true);
    input.disabled = true; // é˜²æ­¢é‡è¤‡é€å‡º

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ sessionId: sid, text })
      });
      const data = await res.json();
      
      // 3. éš±è—è¼‰å…¥ä¸­ä¸¦é¡¯ç¤ºå›æ‡‰
      showLoading(false);
      appendMessage('bot', data.reply);

    } catch (e) {
      showLoading(false);
      appendMessage('bot', `[ç³»çµ±éŒ¯èª¤] ç„¡æ³•é€£ç·šä¼ºæœå™¨ï¼š${e}`);
    } finally {
      input.disabled = false;
      input.focus();
    }
  }

  sendBtn.onclick = send;
  input.addEventListener('keydown', (e) => { 
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send(); 
    }
  });
</script>
</body>
</html>